diff --git a/dist/index.js b/dist/index.js
index 17b568d2dccf01138bc158d955009cbaa894158f..c3be94a2e3be69013e2ce5efc57f6cd1b82a97d8 100644
--- a/dist/index.js
+++ b/dist/index.js
@@ -5619,12 +5619,29 @@ function runToolsTransformation({
   const toolCallsByToolCallId = /* @__PURE__ */ new Map();
   let canClose = false;
   let finishChunk = void 0;
+  let isClosed = false;
+  let toolsStarted = 0;
+  let toolsCompleted = 0;
+  function safeEnqueue(value) {
+    if (isClosed) return;
+    try {
+      toolResultsStreamController.enqueue(value);
+    } catch (e) {
+      if (e instanceof TypeError && e.message.includes("Controller is already closed")) {
+        isClosed = true;
+        return;
+      }
+      throw e;
+    }
+  }
   function attemptClose() {
-    if (canClose && outstandingToolResults.size === 0) {
+    if (isClosed) return;
+    if (canClose && toolsStarted === toolsCompleted) {
+      isClosed = true;
       if (finishChunk != null) {
-        toolResultsStreamController.enqueue(finishChunk);
+        try { toolResultsStreamController.enqueue(finishChunk); } catch (e) {}
       }
-      toolResultsStreamController.close();
+      try { toolResultsStreamController.close(); } catch (e) {}
     }
   }
   const forwardStream = new TransformStream({
@@ -5671,7 +5688,7 @@ function runToolsTransformation({
         case "tool-approval-request": {
           const toolCall = toolCallsByToolCallId.get(chunk.toolCallId);
           if (toolCall == null) {
-            toolResultsStreamController.enqueue({
+            safeEnqueue({
               type: "error",
               error: new ToolCallNotFoundForApprovalError({
                 toolCallId: chunk.toolCallId,
@@ -5699,7 +5716,7 @@ function runToolsTransformation({
             toolCallsByToolCallId.set(toolCall.toolCallId, toolCall);
             controller.enqueue(toolCall);
             if (toolCall.invalid) {
-              toolResultsStreamController.enqueue({
+              safeEnqueue({
                 type: "tool-error",
                 toolCallId: toolCall.toolCallId,
                 toolName: toolCall.toolName,
@@ -5729,7 +5746,7 @@ function runToolsTransformation({
               messages,
               experimental_context
             })) {
-              toolResultsStreamController.enqueue({
+              safeEnqueue({
                 type: "tool-approval-request",
                 approvalId: generateId2(),
                 toolCall
@@ -5738,8 +5755,7 @@ function runToolsTransformation({
             }
             toolInputs.set(toolCall.toolCallId, toolCall.input);
             if (tool2.execute != null && toolCall.providerExecuted !== true) {
-              const toolExecutionId = generateId2();
-              outstandingToolResults.add(toolExecutionId);
+              toolsStarted++;
               executeToolCall({
                 toolCall,
                 tools,
@@ -5749,29 +5765,30 @@ function runToolsTransformation({
                 abortSignal,
                 experimental_context,
                 onPreliminaryToolResult: (result) => {
-                  toolResultsStreamController.enqueue(result);
+                  safeEnqueue(result);
                 }
               }).then((result) => {
-                toolResultsStreamController.enqueue(result);
+                safeEnqueue(result);
+                toolsCompleted++;
+                attemptClose();
               }).catch((error) => {
-                toolResultsStreamController.enqueue({
+                safeEnqueue({
                   type: "error",
                   error
                 });
-              }).finally(() => {
-                outstandingToolResults.delete(toolExecutionId);
+                toolsCompleted++;
                 attemptClose();
               });
             }
           } catch (error) {
-            toolResultsStreamController.enqueue({ type: "error", error });
+            safeEnqueue({ type: "error", error });
           }
           break;
         }
         case "tool-result": {
           const toolName = chunk.toolName;
           if (chunk.isError) {
-            toolResultsStreamController.enqueue({
+            safeEnqueue({
               type: "tool-error",
               toolCallId: chunk.toolCallId,
               toolName,
diff --git a/dist/index.mjs b/dist/index.mjs
index 1767a643a3818a205227982120d5e40d799f26e0..d53fb91d34bf535ec0fca93caa7f77595e51cc47 100644
--- a/dist/index.mjs
+++ b/dist/index.mjs
@@ -5545,12 +5545,29 @@ function runToolsTransformation({
   const toolCallsByToolCallId = /* @__PURE__ */ new Map();
   let canClose = false;
   let finishChunk = void 0;
+  let isClosed = false;
+  let toolsStarted = 0;
+  let toolsCompleted = 0;
+  function safeEnqueue(value) {
+    if (isClosed) return;
+    try {
+      toolResultsStreamController.enqueue(value);
+    } catch (e) {
+      if (e instanceof TypeError && e.message.includes("Controller is already closed")) {
+        isClosed = true;
+        return;
+      }
+      throw e;
+    }
+  }
   function attemptClose() {
-    if (canClose && outstandingToolResults.size === 0) {
+    if (isClosed) return;
+    if (canClose && toolsStarted === toolsCompleted) {
+      isClosed = true;
       if (finishChunk != null) {
-        toolResultsStreamController.enqueue(finishChunk);
+        try { toolResultsStreamController.enqueue(finishChunk); } catch (e) {}
       }
-      toolResultsStreamController.close();
+      try { toolResultsStreamController.close(); } catch (e) {}
     }
   }
   const forwardStream = new TransformStream({
@@ -5597,7 +5614,7 @@ function runToolsTransformation({
         case "tool-approval-request": {
           const toolCall = toolCallsByToolCallId.get(chunk.toolCallId);
           if (toolCall == null) {
-            toolResultsStreamController.enqueue({
+            safeEnqueue({
               type: "error",
               error: new ToolCallNotFoundForApprovalError({
                 toolCallId: chunk.toolCallId,
@@ -5625,7 +5642,7 @@ function runToolsTransformation({
             toolCallsByToolCallId.set(toolCall.toolCallId, toolCall);
             controller.enqueue(toolCall);
             if (toolCall.invalid) {
-              toolResultsStreamController.enqueue({
+              safeEnqueue({
                 type: "tool-error",
                 toolCallId: toolCall.toolCallId,
                 toolName: toolCall.toolName,
@@ -5655,7 +5672,7 @@ function runToolsTransformation({
               messages,
               experimental_context
             })) {
-              toolResultsStreamController.enqueue({
+              safeEnqueue({
                 type: "tool-approval-request",
                 approvalId: generateId2(),
                 toolCall
@@ -5664,8 +5681,7 @@ function runToolsTransformation({
             }
             toolInputs.set(toolCall.toolCallId, toolCall.input);
             if (tool2.execute != null && toolCall.providerExecuted !== true) {
-              const toolExecutionId = generateId2();
-              outstandingToolResults.add(toolExecutionId);
+              toolsStarted++;
               executeToolCall({
                 toolCall,
                 tools,
@@ -5675,29 +5691,30 @@ function runToolsTransformation({
                 abortSignal,
                 experimental_context,
                 onPreliminaryToolResult: (result) => {
-                  toolResultsStreamController.enqueue(result);
+                  safeEnqueue(result);
                 }
               }).then((result) => {
-                toolResultsStreamController.enqueue(result);
+                safeEnqueue(result);
+                toolsCompleted++;
+                attemptClose();
               }).catch((error) => {
-                toolResultsStreamController.enqueue({
+                safeEnqueue({
                   type: "error",
                   error
                 });
-              }).finally(() => {
-                outstandingToolResults.delete(toolExecutionId);
+                toolsCompleted++;
                 attemptClose();
               });
             }
           } catch (error) {
-            toolResultsStreamController.enqueue({ type: "error", error });
+            safeEnqueue({ type: "error", error });
           }
           break;
         }
         case "tool-result": {
           const toolName = chunk.toolName;
           if (chunk.isError) {
-            toolResultsStreamController.enqueue({
+            safeEnqueue({
               type: "tool-error",
               toolCallId: chunk.toolCallId,
               toolName,
