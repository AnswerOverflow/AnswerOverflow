---
description: All Discord.js client access must go through Discord service interface - no direct client access
globs: apps/discord-bot/**/*.ts,apps/discord-bot/**/*.tsx
---

# Discord Service Abstraction

All Discord.js client operations must go through the `Discord` service interface. **Never access Discord.js client methods directly** outside of the implementation file (`discord-client-real.ts`).

## Architecture

We use a two-service architecture:

1. **DiscordClient** (low-level) - Provides raw Discord.js client access through functions

   - Returns functions, not direct properties
   - Uses a `.use()` pattern for error handling
   - All operations wrapped in Effect

2. **Discord** (high-level) - Provides convenient operations + re-exports low-level API
   - Built on top of DiscordClient
   - Implements high-level operations like `fetchChannelMessages`
   - Re-exports low-level client access via `discord.client`

## Why This Rule Exists

- **Testability**: Makes it easy to mock Discord operations in tests
- **Consistency**: All Discord operations follow the same pattern
- **Abstraction**: Allows swapping Discord.js implementations without changing application code
- **Type Safety**: Centralized error handling and type definitions
- **Mockability**: Both mocked and real implementations run the same logic for high-level operations

## Rules

### ❌ Never Do This

```typescript
// Direct channel method access
const messages = await channel.messages.fetch({ limit: 100 });
const threads = await channel.threads.fetchActive();
const archived = await channel.threads.fetchArchived({ type: "public" });

// Direct client access
const guild = client.guilds.cache.get(guildId);
const channel = client.channels.cache.get(channelId);
```

### ✅ Always Do This

```typescript
// Use Discord service for high-level operations
const discord = yield * Discord;
const messages =
  yield * discord.fetchChannelMessages(channelId, { limit: 100 });
const activeThreads = yield * discord.fetchActiveThreads(forumChannelId);
const archivedThreads =
  yield * discord.fetchArchivedThreads(forumChannelId, { before: threadId });

// Use high-level convenience methods
const guild = yield * discord.getGuild(guildId);
const channel = yield * discord.getChannel(channelId);
const channels = yield * discord.getChannels(guildId);

// Or use low-level client access when needed
const guild = yield * discord.client.guilds.cache.get(guildId);
const channel = yield * discord.client.channels.cache.get(channelId);
```

## Implementation File Exception

The **only** exception is `apps/discord-bot/src/discord-client-real.ts`, which is the implementation of the Discord services. This file is allowed to access the Discord.js client directly because it's the abstraction layer itself.

## Available Service Methods

### High-Level Discord Service Methods

**Guild Operations:**

- `discord.getGuild(id: string)` - Get a guild by ID
- `discord.getGuilds()` - Get all guilds the bot is in

**Channel Operations:**

- `discord.getChannel(id: string)` - Get a channel by ID
- `discord.getChannels(guildId: string)` - Get all channels in a guild

**Message Operations:**

- `discord.fetchChannelMessages(channelId: string, options: { limit: number; after?: string })` - Fetch messages from a channel or thread

**Thread Operations:**

- `discord.fetchActiveThreads(forumChannelId: string)` - Fetch active threads from a forum channel
- `discord.fetchArchivedThreads(forumChannelId: string, options: { before?: string })` - Fetch archived threads from a forum channel

### Low-Level Client Access

Access raw Discord.js client operations through `discord.client`:

**Guild Operations:**

- `discord.client.guilds.cache.get(id: string)` - Get a guild from cache
- `discord.client.guilds.cache.values()` - Get all guilds from cache

**Channel Operations:**

- `discord.client.channels.cache.get(id: string)` - Get a channel from cache

**Event Subscription:**

- `discord.client.on(event, handler)` - Subscribe to Discord.js client events

**Login:**

- `discord.client.login()` - Login to Discord

## Adding New Discord Operations

### For Low-Level Operations:

1. **Add the method to** `DiscordClientService` type in `discord-client.ts`
2. **Implement using the `.use()` pattern** in `createDiscordClientService` in `discord-client-real.ts`
3. **Return a function**, not a direct property

### For High-Level Operations:

1. **Add the method to** `DiscordService` type in `discord-client.ts`
2. **Implement using low-level client** in `createDiscordService` in `discord-client-real.ts`
3. **This ensures** both mocked and real implementations run the same logic

## Examples

### Fetching Messages

```typescript
// ❌ Bad - direct access
function fetchMessages(channel: TextChannel) {
  return channel.messages.fetch({ limit: 100 });
}

// ✅ Good - through high-level service
function fetchMessages(discord: DiscordService, channelId: string) {
  return discord.fetchChannelMessages(channelId, { limit: 100 });
}
```

### Accessing Guilds

```typescript
// ❌ Bad - direct client access
const guilds = client.guilds.cache.values();

// ✅ Good - through high-level service
const discord = yield * Discord;
const guilds = yield * discord.getGuilds();

// ✅ Also good - through low-level client
const guilds = yield * discord.client.guilds.cache.values();
```

### Using the .use() Pattern

When implementing low-level operations in `discord-client-real.ts`:

```typescript
// ✅ Good - returns a function using .use()
guilds: {
  cache: {
    get: (id: string) =>
      use((c) => {
        const guild = c.guilds.cache.get(id);
        return guild ?? null;
      }),
  },
},

// ❌ Bad - returns direct property
guilds: {
  cache: client.guilds.cache, // Don't do this!
},
```

## Event Handlers

Event handlers receive Discord.js objects as parameters (e.g., `Message`, `Interaction`). Accessing properties on these objects is fine - the rule applies to **client operations**, not reading properties from event objects.

```typescript
// ✅ This is fine - accessing properties on event objects
const discord = yield * Discord;
yield *
  discord.client.on("messageCreate", (message) =>
    Effect.gen(function* () {
      const channelId = message.channel.id; // OK - reading property
      const authorId = message.author.id; // OK - reading property

      // Use service for operations
      const channel = yield* discord.getChannel(channelId); // OK - using service
    })
  );
```
